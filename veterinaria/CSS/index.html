<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário com Restrição</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const usuariosAutorizados = {
            "usuario1": "senha123"
        };

        let latitudeUsuario, longitudeUsuario;
        let qrCodeLinkGerado = false; // Variável para verificar se o link foi gerado

        // Função para autenticar o usuário no login
        function autenticarUsuario() {
            const usuario = document.getElementById("usuario").value;
            const senha = document.getElementById("senha").value;

            if (usuariosAutorizados[usuario] === senha) {
                document.getElementById("login").style.display = "none";
                document.getElementById("dashboard").style.display = "block";

                navigator.geolocation.getCurrentPosition((position) => {
                    latitudeUsuario = Math.round(position.coords.latitude * 1e6) / 1e6;
                    longitudeUsuario = Math.round(position.coords.longitude * 1e6) / 1e6;
                    console.log("Localização do gerador capturada:", latitudeUsuario, longitudeUsuario);

                    if (!qrCodeLinkGerado) {
                        gerarQRCode(); // Gera o QR Code apenas uma vez
                        qrCodeLinkGerado = true;
                    }
                }, (error) => {
                    alert("Erro ao obter localização: " + error.message);
                }, { enableHighAccuracy: true });
            } else {
                alert("Usuário ou senha inválidos!");
            }
        }

        // Função para gerar QR Code com a localização do gerador
        function gerarQRCode() {
            if (latitudeUsuario && longitudeUsuario) {
                const timestamp = Date.now(); // Gerar um identificador único
                const linkUnico = `${window.location.origin}/formulariommm.html?latGerador=${latitudeUsuario}&lonGerador=${longitudeUsuario}&token=${timestamp}`;
                console.log("Link do QR Code:", linkUnico);

                const qrCodeContainer = document.getElementById("qrcode");
                qrCodeContainer.innerHTML = ""; // Limpa o QR Code anterior

                new QRCode(qrCodeContainer, {
                    text: linkUnico,
                    width: 128,
                    height: 128
                });

                document.getElementById("qrcodeContainer").style.display = "block";
            } else {
                alert("Localização do gerador não detectada. Tente novamente.");
            }
        }

        // Função para validar o acesso ao formulário
        function validarAcesso() {
            const urlParams = new URLSearchParams(window.location.search);
            const latGerador = parseFloat(urlParams.get('latGerador'));
            const lonGerador = parseFloat(urlParams.get('lonGerador'));
            const timestamp = parseFloat(urlParams.get('token'));

            // Mostrar mensagem de "Calculando a distância"
            document.getElementById("calculando").style.display = "block";
            document.getElementById("acessoNegado").style.display = "none";
            document.getElementById("formulariommm").style.display = "none";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const latUsuario = position.coords.latitude;
                    const lonUsuario = position.coords.longitude;

                    // Enviar a validação ao servidor
                    fetch(`/validate-form?latGerador=${latGerador}&lonGerador=${lonGerador}&latUsuario=${latUsuario}&lonUsuario=${lonUsuario}&timestamp=${timestamp}`)
                        .then(response => response.json())
                        .then(data => {
                            // Esconder a mensagem "Calculando a distância"
                            document.getElementById("calculando").style.display = "none";

                            if (data.message === "Acesso permitido") {
                                document.getElementById("formulariommm").style.display = "block";
                                document.getElementById("acessoNegado").style.display = "none";
                            } else {
                                document.getElementById("formulariommm").style.display = "none";
                                document.getElementById("acessoNegado").style.display = "block";
                            }
                        });
                }, error => {
                    alert("Erro ao obter sua localização.");
                });
            } else {
                alert("Seu navegador não suporta geolocalização.");
            }
        }
    </script>
</head>
<body>
    <!-- Login -->
    <div id="login">
        <h2>Login</h2>
        <label for="usuario">Usuário:</label>
        <input type="text" id="usuario" required><br><br>
        <label for="senha">Senha:</label>
        <input type="password" id="senha" required><br><br>
        <button onclick="autenticarUsuario()">Entrar</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <h2>Bem-vindo!</h2>
        <button onclick="gerarQRCode()">Iniciar Chamada</button>
        <div id="qrcodeContainer" style="display: none;">
            <h3>Escaneie o QR Code:</h3>
            <div id="qrcode"></div>
        </div>
    </div>

    <!-- Mensagem enquanto calcula a distância -->
    <div id="calculando" style="display: none;">
        <h3>Calculando a distância...</h3>
    </div>

    <!-- Formulário -->
    <div id="formulariommm" style="display: none;">
        <h2>Formulário de Presença</h2>
        <form method="POST" action="/submit-form">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" required><br><br>
            <label for="rgm">RGM:</label>
            <input type="text" id="rgm" name="rgm" required><br><br>
            <label for="turma">Turma:</label>
            <input type="text" id="turma" name="turma" required><br><br>
            <button type="submit">Enviar</button>
        </form>
    </div>

    <!-- Mensagem de acesso negado -->
    <div id="acessoNegado" style="display: none;">
        <h2>Acesso negado</h2>
        <p>Você está fora do limite permitido para acessar este formulário.</p>
    </div>

    <script>
        // Chama a validação automaticamente ao carregar o formulário
        if (window.location.pathname === '/formulariommm.html') {
            validarAcesso();
        }
    </script>
</body>
</html>
